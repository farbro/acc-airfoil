#cloud-config

apt_update: true
apt_upgrade: true

packages:
 - python3-pip
 - build-essential
 - rabbitmq-server
 - nfs-kernel-server
 - avahi-daemon 
 - avahi-discover
 - avahi-utils
 - libnss-mdns
 - mdns-scan

byobu_default: system 

users:
 - default
 - name: airfoil
   groups: airfoil
   system: true
   sudo: false

write_files:
 - path: /etc/exports
   content: |
     /home/ubuntu/acc-airfoil/data  192.168.2.0/24(ro,sync,no_subtree_check)

runcmd:
 - pip3 install Flask
 - pip3 install -Iv celery==4.4.7
 - pip3 install flower

 - rabbitmqctl add_user worker fnurkgurk
 - rabbitmqctl add_vhost twhost
 - rabbitmqctl set_user_tags worker worker
 - rabbitmqctl set_permissions -p twhost worker ".*" ".*" ".*"

 - cd /home/ubuntu
 - git clone https://github.com/farbro/acc-airfoil.git
 - cd acc-airfoil
 - git checkout secure

 # Set priveleges
 - chown -R ubuntu:airfoil /home/ubuntu/acc-airfoil 
 - chmod -R 644 /home/ubuntu/acc-airfoil 
 - chmod 755 /home/ubuntu/acc-airfoil 

 - mkdir data
 - chown nobody:nogroup data
 - chmod 777 data
 - exportfs -a
 - sytemctl restart nfs-kernel-server
 
# Install flower service
 - cp /home/ubuntu/acc-airfoil/deploy/services/airfoil-flower.service /etc/systemd/
 - systemctl start airfoil-flower
 - systemctl enable airfoil-flower

# Install airfoil app service
 - cp /home/ubuntu/acc-airfoil/deploy/services/airfoil-main.service /etc/systemd/
 - systemctl start airfoil-main
 - systemctl enable airfoil-main
